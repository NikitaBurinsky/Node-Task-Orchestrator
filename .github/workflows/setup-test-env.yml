name: Deploy Test Infrastructure (VPS)

on:
  workflow_dispatch:
    inputs:
      node_count:
        description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (—Å–µ—Ä–≤–µ—Ä–æ–≤)'
        required: true
        default: '3'
        type: string
      start_port:
        description: '–ù–∞—á–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2220 -> 2221, 2222...)'
        required: true
        default: '2220'
        type: string

jobs:
  deploy-nodes:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: 22
          script: |
            # === –ù–ê–°–¢–†–û–ô–ö–ò ===
            NODE_COUNT=${{ inputs.node_count }}
            START_PORT=${{ inputs.start_port }}
            WORK_DIR=~/nto_test_infra
            IMAGE_NAME=nto-ssh-node
            
            echo "üöÄ –ù–∞—á–∞–ª–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è $NODE_COUNT –Ω–æ–¥..."
            
            # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            mkdir -p $WORK_DIR
            cd $WORK_DIR
            
            # 2. –°–æ–∑–¥–∞–Ω–∏–µ Dockerfile –Ω–∞ –ª–µ—Ç—É (Alpine + SSH)
            cat <<EOF > Dockerfile
            FROM alpine:latest
            RUN apk add --no-cache openssh bash
            RUN ssh-keygen -A
            RUN echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config && \\
                echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config
            # –ü–∞—Ä–æ–ª—å: root / toor
            RUN echo 'root:toor' | chpasswd
            EXPOSE 22
            CMD ["/usr/sbin/sshd", "-D"]
            EOF
            
            # 3. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (Idempotency)
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–æ –∏–º–µ–Ω–∏
            for i in $(seq 1 $NODE_COUNT); do
              CONTAINER_NAME="nto_node_$i"
              if docker ps -a --format '{{.Names}}' | grep -q "^$CONTAINER_NAME$"; then
                echo "–£–¥–∞–ª–µ–Ω–∏–µ $CONTAINER_NAME..."
                docker rm -f $CONTAINER_NAME 2>/dev/null || true
              fi
            done
            
            # 4. –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ 
            echo "üî® –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
            docker build -t $IMAGE_NAME .
 
            # 5. –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤  
            echo "üî• –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            
            for i in $(seq 1 $NODE_COUNT); do
              # –í—ã—á–∏—Å–ª—è–µ–º –ø–æ—Ä—Ç: START_PORT + i
              CURRENT_PORT=$((START_PORT + i))
              CONTAINER_NAME="nto_node_$i"
            
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –ø–æ—Ä—Ç
              if docker ps -a --format '{{.Ports}}' | grep -q "0.0.0.0:$CURRENT_PORT"; then
                echo "‚ö†Ô∏è –ü–æ—Ä—Ç $CURRENT_PORT —É–∂–µ –∑–∞–Ω—è—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ $CONTAINER_NAME"
                continue
              fi
            
              # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–í–ê–ñ–ù–û: –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è $)
              docker run -d \
                -p $CURRENT_PORT:22 \
                --name $CONTAINER_NAME \
                --hostname "linux-server-$i" \
                --restart unless-stopped \
                $IMAGE_NAME
            
              echo "‚úÖ –°–æ–∑–¥–∞–Ω $CONTAINER_NAME –Ω–∞ –ø–æ—Ä—Ç—É $CURRENT_PORT"
            done
            
            echo "üèÅ –ì–æ—Ç–æ–≤–æ! –°–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –Ω–æ–¥:"
            echo "========================"
            docker ps --filter "name=nto_node" --format "table {{.Names}}\t{{.Ports}}\t{{.Status}}"
            
            echo ""
            echo "üìù –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
            echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: root"
            echo "–ü–∞—Ä–æ–ª—å: toor"
            for i in $(seq 1 $NODE_COUNT); do
              CURRENT_PORT=$((START_PORT + i))
              echo "–ù–æ–¥–∞ $i: ssh root@${{ secrets.VPS_HOST }} -p $CURRENT_PORT"
            done