name: Deploy PostgreSQL DB (VPS)

on:
  workflow_dispatch:

jobs:
  deploy-postgres:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy DB to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: 22
          script: |
            # === –ù–ê–°–¢–†–û–ô–ö–ò –ò–ó application.properties ===
            CONTAINER_NAME="nto_db_container"
            DB_NAME="nto_db"
            DB_USER="postgres"
            DB_PASS="supermegrovibroblastsuperdupersocialist"
            HOST_PORT="5400"
            VOLUME_NAME="nto_pg_data"

            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ PostgreSQL..."

            # 1. –°–æ–∑–¥–∞–µ–º Docker Volume –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ë–î –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            docker volume create $VOLUME_NAME

            # 2. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –æ–Ω —É–∂–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω)
            echo "üßπ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            if [ "$(docker ps -aq -f name=$CONTAINER_NAME)" ]; then
                echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ $CONTAINER_NAME..."
                docker rm -f $CONTAINER_NAME
            fi

            # 3. –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –ø—Ä–æ–±—Ä–æ—Å–æ–º –ø–æ—Ä—Ç–∞ 5400 -> 5432
            echo "üî• –ó–∞–ø—É—Å–∫ PostgreSQL..."
            docker run -d \
              --name $CONTAINER_NAME \
              -p $HOST_PORT:5432 \
              -e POSTGRES_DB=$DB_NAME \
              -e POSTGRES_USER=$DB_USER \
              -e POSTGRES_PASSWORD=$DB_PASS \
              -v $VOLUME_NAME:/var/lib/postgresql/data \
              --restart unless-stopped \
              postgres:15-alpine

            echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞!"
            echo "–î–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: jdbc:postgresql://2.56.240.190:$HOST_PORT/$DB_NAME"